<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPFS é›¢ç·šè¨˜äº‹æœ¬ç®¡ç†å™¨</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 0 10px; line-height: 1.6; }
        .controls { background: #f4f4f4; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .file-list { border: 1px solid #ddd; border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
        .file-item:hover { background: #f0f7ff; }
        .file-item.active { background: #e3f2fd; font-weight: bold; }
        .editor-area { margin-top: 20px; }
        textarea { width: 100%; height: 200px; margin-top: 10px; padding: 10px; box-sizing: border-box; }
        button { cursor: pointer; padding: 5px 15px; margin-right: 5px; }
        .btn-save { background: #4CAF50; color: white; border: none; padding: 10px 20px; }
        .btn-delete { background: #f44336; color: white; border: none; }
        .status { font-size: 0.9em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <h2>ğŸ“ OPFS æª”æ¡ˆç®¡ç†å™¨</h2>

    <div class="controls">
        <input type="text" id="newFileName" placeholder="æ–°æª”æ¡ˆåç¨± (ä¾‹å¦‚: note1)"> .txt
        <button onclick="createNewFile()">æ–°å¢æª”æ¡ˆ</button>
    </div>

    <h3>æª”æ¡ˆåˆ—è¡¨</h3>
    <div id="fileList" class="file-list">è®€å–ä¸­...</div>
    <div id="status" class="status"></div>

    <div class="editor-area" id="editorArea" style="display:none;">
        <h3>æ­£åœ¨ç·¨è¼¯ï¼š<span id="currentFileNameDisplay"></span></h3>
        <textarea id="editorContent"></textarea><br>
        <button class="btn-save" onclick="saveCurrentFile()">å„²å­˜å…§å®¹</button>
        <button class="btn-delete" onclick="deleteCurrentFile()">åˆªé™¤æ­¤æª”æ¡ˆ</button>
    </div>

    <script>
        let currentFileHandle = null;

        // åˆå§‹åŒ–ï¼šåˆ—å‡ºæ‰€æœ‰æª”æ¡ˆ
        async function refreshFileList() {
            const fileListElement = document.getElementById('fileList');
            fileListElement.innerHTML = '';
            
            try {
                const root = await navigator.storage.getDirectory();
                let hasFiles = false;

                // è¿­ä»£æ ¹ç›®éŒ„ä¸‹çš„æ‰€æœ‰é …ç›®
                for await (const entry of root.values()) {
                    if (entry.kind === 'file') {
                        hasFiles = true;
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        if (currentFileHandle && currentFileHandle.name === entry.name) {
                            div.classList.add('active');
                        }
                        div.innerHTML = `<span>${entry.name}</span>`;
                        div.onclick = () => openFile(entry.name);
                        fileListElement.appendChild(div);
                    }
                }

                if (!hasFiles) {
                    fileListElement.innerHTML = '<div style="color:#999">ç›®å‰æ²’æœ‰ä»»ä½•æª”æ¡ˆ</div>';
                }
            } catch (err) {
                showStatus("è®€å–æ¸…å–®å¤±æ•—: " + err.message);
            }
        }

        // 1. æ–°å¢æª”æ¡ˆ
        async function createNewFile() {
            const input = document.getElementById('newFileName');
            let name = input.value.trim();
            if (!name) return alert("è«‹è¼¸å…¥æª”å");
            if (!name.endsWith('.txt')) name += '.txt';

            try {
                const root = await navigator.storage.getDirectory();
                // å»ºç«‹æª”æ¡ˆ (å¦‚æœå·²å­˜åœ¨æœƒç›´æ¥é–‹å•Ÿ)
                await root.getFileHandle(name, { create: true });
                input.value = '';
                showStatus(`å·²å»ºç«‹ ${name}`);
                await refreshFileList();
                await openFile(name); // è‡ªå‹•é–‹å•Ÿæ–°æª”
            } catch (err) {
                showStatus("å»ºç«‹å¤±æ•—: " + err.message);
            }
        }

        // 2. é–‹å•Ÿæª”æ¡ˆè®€å–
        async function openFile(name) {
            try {
                const root = await navigator.storage.getDirectory();
                currentFileHandle = await root.getFileHandle(name);
                
                const file = await currentFileHandle.getFile();
                const content = await file.text();

                document.getElementById('editorArea').style.display = 'block';
                document.getElementById('currentFileNameDisplay').innerText = name;
                document.getElementById('editorContent').value = content;
                
                refreshFileList();
                showStatus(`å·²è¼‰å…¥ ${name}`);
            } catch (err) {
                showStatus("è®€å–å¤±æ•—: " + err.message);
            }
        }

        // 3. å„²å­˜ç›®å‰ç·¨è¼¯çš„æª”æ¡ˆ
        async function saveCurrentFile() {
            if (!currentFileHandle) return;
            const content = document.getElementById('editorContent').value;

            try {
                const writable = await currentFileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                showStatus("âœ… å„²å­˜æˆåŠŸï¼");
            } catch (err) {
                showStatus("å„²å­˜å¤±æ•—: " + err.message);
            }
        }

        // 4. åˆªé™¤ç›®å‰æª”æ¡ˆ
        async function deleteCurrentFile() {
            if (!currentFileHandle) return;
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${currentFileHandle.name} å—ï¼Ÿ`)) return;

            try {
                const root = await navigator.storage.getDirectory();
                await root.removeEntry(currentFileHandle.name);
                
                currentFileHandle = null;
                document.getElementById('editorArea').style.display = 'none';
                showStatus("ğŸ—‘ï¸ æª”æ¡ˆå·²åˆªé™¤");
                refreshFileList();
            } catch (err) {
                showStatus("åˆªé™¤å¤±æ•—: " + err.message);
            }
        }

        function showStatus(msg) {
            document.getElementById('status').innerText = msg;
            setTimeout(() => { document.getElementById('status').innerText = ""; }, 3000);
        }

        // ç¶²é é–‹å•Ÿæ™‚åŸ·è¡Œ
        refreshFileList();
    </script>
</body>
</html>