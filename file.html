<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°è³‡æ–™å¤¾ç®¡ç†å™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ç¢ºä¿è‰¯å¥½é¡¯ç¤ºæ•ˆæœ */
        body { font-family: 'Inter', sans-serif; }
        /* é‡å°è³‡æ–™å¤¾åç¨±ä½¿ç”¨ç­‰å¯¬å­—é«” */
        .folder-name { font-family: monospace; }
        /* Modal é¡¯ç¤ºæ™‚ç¦æ­¢æ»¾å‹• */
        .modal-open { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-blue-100">
        
        <h1 class="text-3xl font-extrabold text-blue-700 mb-2">ğŸ“ æœ¬åœ°è³‡æ–™å¤¾ç®¡ç†å™¨</h1>
        <p class="text-red-600 font-semibold mb-4 p-3 bg-red-50 rounded-lg border border-red-200">
            ğŸš¨ **é‡è¦é™åˆ¶ï¼š** ç”±æ–¼ç€è¦½å™¨å®‰å…¨æ”¿ç­–ï¼Œæ­¤å·¥å…·ä¸­çš„ã€Œé¸æ“‡è³‡æ–™å¤¾ã€åŠŸèƒ½**å¿…é ˆ**åœ¨ç¨ç«‹çš„ç€è¦½å™¨åˆ†é ä¸­é–‹å•Ÿæ­¤æª”æ¡ˆæ‰èƒ½é‹ä½œã€‚
        </p>
        <p class="text-gray-500 mb-6">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æ‚¨è¦ç®¡ç†çš„è³‡æ–™å¤¾ã€‚æ­¤å·¥å…·éœ€è¦æ‚¨æ˜ç¢ºæˆäºˆè®€å–/å¯«å…¥æ¬Šé™ã€‚</p>

        <!-- ä¸»è¦æ§åˆ¶å€å¡Š -->
        <div id="controls" class="space-y-4">
            <button id="openDirBtn" onclick="openDirectory()" 
                    class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                ğŸš€ é¸æ“‡è¦å­˜å–çš„è³‡æ–™å¤¾
            </button>
            <div id="selectedPathDisplay" class="text-sm text-gray-700 font-medium p-3 bg-blue-50 rounded-lg hidden">
                ç›®å‰é¸å–çš„è·¯å¾‘: <span id="currentPath" class="text-blue-800 break-all"></span>
            </div>
        </div>

        <!-- è¨Šæ¯/ç‹€æ…‹å€å¡Š -->
        <div id="statusMessage" class="mt-4 p-3 text-sm text-yellow-800 bg-yellow-100 rounded-lg hidden">
            <!-- ç‹€æ…‹è¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- å…§å®¹ç®¡ç†å€å¡Š (åªæœ‰åœ¨é¸å–è³‡æ–™å¤¾å¾Œæ‰é¡¯ç¤º) -->
        <div id="managerArea" class="mt-8 pt-8 border-t border-gray-200 hidden">
            
            <h2 class="text-2xl font-bold text-gray-800 mb-4">è³‡æ–™å¤¾å…§å®¹</h2>

            <!-- æ–°å¢æª”æ¡ˆæˆ–è³‡æ–™å¤¾ -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">â• æ–°å¢é …ç›® (æª”æ¡ˆæˆ–è³‡æ–™å¤¾)</h3>
                
                <!-- å»ºç«‹è³‡æ–™å¤¾ -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <input type="text" id="newFolderName" placeholder="è¼¸å…¥æ–°çš„è³‡æ–™å¤¾åç¨±" 
                           class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <button onclick="createFolder()" 
                            class="px-4 py-2 w-full sm:w-auto bg-indigo-500 text-white font-medium rounded-lg shadow-sm hover:bg-indigo-600 transition duration-150">
                        å»ºç«‹è³‡æ–™å¤¾
                    </button>
                </div>

                <!-- å»ºç«‹æª”æ¡ˆ -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <input type="text" id="newFileName" placeholder="è¼¸å…¥æ–°çš„æª”æ¡ˆåç¨± (å¦‚: mydata.txt)" 
                           class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    <button onclick="createFile()" 
                            class="px-4 py-2 w-full sm:w-auto bg-green-500 text-white font-medium rounded-lg shadow-sm hover:bg-green-600 transition duration-150">
                        å»ºç«‹æª”æ¡ˆ (.txt)
                    </button>
                </div>
            </div>

            <!-- è³‡æ–™å¤¾æ¸…å–® -->
            <div id="folderList" class="space-y-2">
                <p class="text-gray-400">è«‹å…ˆé¸å–è³‡æ–™å¤¾...</p>
            </div>
        </div>

    </div>

    <!-- åˆªé™¤ç¢ºèª Modal çµæ§‹ (è‡ªå®šç¾© UI å–ä»£ window.confirm) -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 flex items-center justify-center transition-opacity duration-300" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div id="modalContainer" class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modalTitle" class="text-xl font-bold text-red-600 mb-3">âš ï¸ ç¢ºèªåˆªé™¤</h3>
            <p id="modalMessage" class="text-gray-700 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                    å–æ¶ˆ
                </button>
                <button id="confirmDeleteBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">
                    ç¢ºå®šåˆªé™¤
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸ä¾†å„²å­˜é¸å–çš„è³‡æ–™å¤¾å¥æŸ„ (Handle) å’Œè¦åˆªé™¤çš„é …ç›®è³‡è¨Š { name, kind }
        let rootHandle = null;
        let entryToDelete = null; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const deleteModal = document.getElementById('deleteModal');
        const modalContainer = document.getElementById('modalContainer');
        const modalMessage = document.getElementById('modalMessage');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // Modal ç›¸é—œé‚è¼¯
        /**
         * é¡¯ç¤ºåˆªé™¤ç¢ºèª Modal
         * @param {string} entryName è¦åˆªé™¤çš„é …ç›®åç¨±
         * @param {string} kind é …ç›®é¡å‹ ('file' æˆ– 'directory')
         */
        function showModal(entryName, kind) {
            entryToDelete = { name: entryName, kind: kind };
            const typeText = kind === 'directory' ? 'è³‡æ–™å¤¾' : 'æª”æ¡ˆ';
            const warningText = kind === 'directory' ? 'åŠå…¶æ‰€æœ‰å…§å®¹å—ï¼Ÿ' : 'å—ï¼Ÿ';

            modalMessage.innerHTML = `æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤ ${typeText} <span class="font-bold text-red-700">"${entryName}"</span> ${warningText} æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼`;
            
            // é¡¯ç¤º Modal
            deleteModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
            // è§¸ç™¼éæ¸¡å‹•ç•«
            setTimeout(() => {
                deleteModal.classList.add('opacity-100');
                modalContainer.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideModal() {
            // è§¸ç™¼åå‘éæ¸¡å‹•ç•«
            deleteModal.classList.remove('opacity-100');
            modalContainer.classList.add('scale-95', 'opacity-0');

            // éš±è— Modal
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
                entryToDelete = null;
            }, 300);
        }

        // ç¶å®š Modal æŒ‰éˆ•äº‹ä»¶
        cancelDeleteBtn.onclick = hideModal;
        confirmDeleteBtn.onclick = () => {
            if (entryToDelete) {
                // å‘¼å«é€šç”¨çš„åˆªé™¤å‡½å¼
                deleteEntry(entryToDelete.name, entryToDelete.kind); 
            }
            hideModal();
        };
        deleteModal.onclick = (e) => {
            if (e.target === deleteModal) {
                hideModal(); // é»æ“ŠèƒŒæ™¯é—œé–‰
            }
        };

        /**
         * é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
         * @param {string} message è¦é¡¯ç¤ºçš„è¨Šæ¯
         * @param {string} type è¨Šæ¯é¡å‹ (success, error, warning)
         */
        function showStatus(message, type = 'warning') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            
            statusDiv.className = 'mt-4 p-3 text-sm rounded-lg';
            statusDiv.classList.remove('hidden');

            if (type === 'success') {
                statusDiv.classList.add('text-green-800', 'bg-green-100');
                statusDiv.classList.remove('text-red-800', 'bg-red-100', 'text-yellow-800', 'bg-yellow-100');
            } else if (type === 'error') {
                statusDiv.classList.add('text-red-800', 'bg-red-100');
                statusDiv.classList.remove('text-green-800', 'bg-green-100', 'text-yellow-800', 'bg-yellow-100');
            } else { // default warning
                statusDiv.classList.add('text-yellow-800', 'bg-yellow-100');
                statusDiv.classList.remove('text-green-800', 'bg-green-100', 'text-red-800', 'bg-red-100');
            }

            // åœ¨å¹¾ç§’å¾Œéš±è—è¨Šæ¯
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        /**
         * æç¤ºä½¿ç”¨è€…é¸æ“‡ä¸€å€‹è³‡æ–™å¤¾ä¸¦ç²å¾—æ¬Šé™
         */
        async function openDirectory() {
            if (!('showDirectoryPicker' in window)) {
                showStatus('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ File System Access APIã€‚è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚', 'error');
                return;
            }

            try {
                // ä½¿ç”¨ showDirectoryPicker è®“ä½¿ç”¨è€…é¸æ“‡è³‡æ–™å¤¾
                rootHandle = await window.showDirectoryPicker();
                
                // è«‹æ±‚å¯«å…¥æ¬Šé™
                const permission = await rootHandle.requestPermission({ mode: 'readwrite' });

                if (permission === 'granted') {
                    document.getElementById('currentPath').textContent = rootHandle.name;
                    document.getElementById('selectedPathDisplay').classList.remove('hidden');
                    document.getElementById('managerArea').classList.remove('hidden');
                    showStatus(`æˆåŠŸå­˜å–è³‡æ–™å¤¾: ${rootHandle.name}ã€‚å·²ç²å¾—è®€å¯«æ¬Šé™ã€‚`, 'success');
                    listContents();
                } else {
                    rootHandle = null;
                    document.getElementById('managerArea').classList.add('hidden');
                    showStatus('æ‚¨æ‹’çµ•äº†è®€å¯«æ¬Šé™ï¼Œç„¡æ³•é€²è¡Œè³‡æ–™å¤¾æ“ä½œã€‚', 'error');
                }

            } catch (error) {
                // ä½¿ç”¨è€…å–æ¶ˆäº†é¸å–
                if (error.name === 'AbortError') {
                    showStatus('ä½¿ç”¨è€…å–æ¶ˆäº†è³‡æ–™å¤¾é¸å–æ“ä½œã€‚');
                } else if (error.name === 'SecurityError' && error.message.includes('sub frames')) {
                    // é‡å°è·¨ä¾†æº iframe çš„ç‰¹å®šéŒ¯èª¤ï¼Œçµ¦å‡ºæ˜ç¢ºæç¤º
                    console.error('é–‹å•Ÿè³‡æ–™å¤¾éŒ¯èª¤:', error);
                    showStatus('éŒ¯èª¤ï¼šç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œæ­¤æ‡‰ç”¨ç¨‹å¼ç„¡æ³•åœ¨è·¨ä¾†æºçš„å­æ¡†æ¶ (å¦‚æœ¬é è¦½è¦–çª—) ä¸­å­˜å–æœ¬åœ°æª”æ¡ˆç³»çµ±ã€‚è«‹å˜—è©¦åœ¨ç¨ç«‹çš„ç€è¦½å™¨åˆ†é ä¸­é–‹å•Ÿæ­¤ HTML æª”æ¡ˆï¼Œæˆ–ä½¿ç”¨å…è¨±æª”æ¡ˆå­˜å–çš„åŸ·è¡Œç’°å¢ƒã€‚', 'error');
                } else {
                    console.error('é–‹å•Ÿè³‡æ–™å¤¾éŒ¯èª¤:', error);
                    showStatus(`é–‹å•Ÿè³‡æ–™å¤¾æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                }
            }
        }

        /**
         * åˆ—å‡ºé¸å®šè³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰é …ç›® (æª”æ¡ˆå’Œè³‡æ–™å¤¾)
         */
        async function listContents() {
            const listContainer = document.getElementById('folderList');
            listContainer.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            
            if (!rootHandle) {
                listContainer.innerHTML = '<p class="text-gray-500">è«‹å…ˆé¸æ“‡è³‡æ–™å¤¾ã€‚</p>';
                return;
            }

            try {
                const entries = [];
                for await (const entry of rootHandle.values()) {
                    entries.push(entry);
                }

                if (entries.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 p-2 bg-gray-100 rounded">æ­¤è³‡æ–™å¤¾ç‚ºç©ºã€‚</p>';
                    return;
                }

                // æ’åºï¼šè³‡æ–™å¤¾åœ¨å‰ï¼Œç„¶å¾ŒæŒ‰åç¨±æ’åº
                entries.sort((a, b) => {
                    if (a.kind === 'directory' && b.kind !== 'directory') return -1;
                    if (a.kind !== 'directory' && b.kind === 'directory') return 1;
                    return a.name.localeCompare(b.name);
                });


                entries.forEach(entry => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between p-3 border border-gray-100 rounded-lg bg-white shadow-sm hover:shadow-md transition duration-150';
                    
                    const icon = entry.kind === 'directory' ? 'ğŸ“' : 'ğŸ“„';
                    
                    // é¡¯ç¤ºåç¨±
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'flex-grow truncate text-gray-800 folder-name';
                    nameSpan.textContent = `${icon} ${entry.name}`;

                    listItem.appendChild(nameSpan);

                    // åˆªé™¤æŒ‰éˆ•
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'åˆªé™¤';
                    deleteBtn.className = 'ml-4 px-3 py-1 text-xs font-semibold text-white bg-red-500 rounded-md hover:bg-red-600 transition duration-150 transform hover:scale-105';
                    // å‚³é name å’Œ kind
                    deleteBtn.onclick = () => showModal(entry.name, entry.kind);
                    listItem.appendChild(deleteBtn);
                    
                    // é¡¯ç¤ºé¡å‹æ¨™ç±¤
                    const typeTag = document.createElement('span');
                    if (entry.kind === 'file') {
                        typeTag.textContent = 'æª”æ¡ˆ';
                        typeTag.className = 'ml-4 px-2 py-1 text-xs font-medium text-gray-500 bg-gray-200 rounded-full';
                    } else if (entry.kind === 'directory') {
                        typeTag.textContent = 'è³‡æ–™å¤¾';
                        typeTag.className = 'ml-4 px-2 py-1 text-xs font-medium text-blue-500 bg-blue-200 rounded-full';
                    }
                    listItem.appendChild(typeTag);

                    listContainer.appendChild(listItem);
                });

            } catch (error) {
                console.error('åˆ—å‡ºå…§å®¹éŒ¯èª¤:', error);
                showStatus(`åˆ—å‡ºè³‡æ–™å¤¾å…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        /**
         * å»ºç«‹ä¸€å€‹æ–°çš„è³‡æ–™å¤¾
         */
        async function createFolder() {
            if (!rootHandle) {
                showStatus('è«‹å…ˆé¸æ“‡ä¸€å€‹è³‡æ–™å¤¾ã€‚');
                return;
            }

            const folderNameInput = document.getElementById('newFolderName');
            const folderName = folderNameInput.value.trim();

            if (!folderName) {
                showStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„è³‡æ–™å¤¾åç¨±ã€‚');
                return;
            }

            try {
                // å˜—è©¦å–å¾—/å»ºç«‹è³‡æ–™å¤¾å¥æŸ„
                await rootHandle.getDirectoryHandle(folderName, { create: true });
                
                showStatus(`è³‡æ–™å¤¾ "${folderName}" å»ºç«‹æˆåŠŸï¼`, 'success');
                folderNameInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                listContents(); // åˆ·æ–°æ¸…å–®

            } catch (error) {
                console.error('å»ºç«‹è³‡æ–™å¤¾éŒ¯èª¤:', error);
                showStatus(`å»ºç«‹è³‡æ–™å¤¾å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        /**
         * å»ºç«‹ä¸€å€‹æ–°çš„æ–‡å­—æª”æ¡ˆ (é è¨­ç‚ºç©º)
         */
        async function createFile() {
            if (!rootHandle) {
                showStatus('è«‹å…ˆé¸æ“‡ä¸€å€‹è³‡æ–™å¤¾ã€‚');
                return;
            }

            const fileNameInput = document.getElementById('newFileName');
            let fileName = fileNameInput.value.trim();

            if (!fileName) {
                showStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„æª”æ¡ˆåç¨±ã€‚');
                return;
            }

            // ç¢ºä¿æª”æ¡ˆåæœ‰å‰¯æª”åï¼Œå¦‚æœæ²’æœ‰ï¼Œé è¨­ç‚º .txt
            if (!fileName.includes('.')) {
                fileName += '.txt';
            }

            try {
                // å–å¾— FileHandle
                const fileHandle = await rootHandle.getFileHandle(fileName, { create: true });
                
                // å»ºç«‹ WritableStream ä¸¦å¯«å…¥å…§å®¹ (ç©ºå­—ä¸²)
                const writable = await fileHandle.createWritable();
                await writable.write(''); 
                await writable.close();

                showStatus(`æª”æ¡ˆ "${fileName}" å»ºç«‹æˆåŠŸï¼ (ç©ºæ–‡å­—æª”)`, 'success');
                fileNameInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                listContents(); // åˆ·æ–°æ¸…å–®

            } catch (error) {
                console.error('å»ºç«‹æª”æ¡ˆéŒ¯èª¤:', error);
                showStatus(`å»ºç«‹æª”æ¡ˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        /**
         * åŸ·è¡Œé …ç›® (æª”æ¡ˆæˆ–è³‡æ–™å¤¾) åˆªé™¤æ“ä½œ
         * @param {string} entryName è¦åˆªé™¤çš„é …ç›®åç¨±
         * @param {string} kind é …ç›®é¡å‹ ('file' æˆ– 'directory')
         */
        async function deleteEntry(entryName, kind) {
            if (!rootHandle) {
                showStatus('è«‹å…ˆé¸æ“‡ä¸€å€‹è³‡æ–™å¤¾ã€‚');
                return;
            }

            try {
                // åˆªé™¤æª”æ¡ˆæ™‚ recursive: false å³å¯ã€‚åˆªé™¤è³‡æ–™å¤¾æ™‚ï¼Œå¿…é ˆä½¿ç”¨ recursive: trueã€‚
                const recursive = kind === 'directory';
                await rootHandle.removeEntry(entryName, { recursive: recursive });
                
                showStatus(`${kind === 'directory' ? 'è³‡æ–™å¤¾' : 'æª”æ¡ˆ'} "${entryName}" å·²æˆåŠŸåˆªé™¤ã€‚`, 'success');
                listContents(); // åˆ·æ–°æ¸…å–®

            } catch (error) {
                console.error('åˆªé™¤é …ç›®éŒ¯èª¤:', error);
                // è™•ç†å¯èƒ½ä¸å­˜åœ¨æˆ–å…¶ä»–æ¬Šé™å•é¡Œ
                showStatus(`åˆªé™¤é …ç›®å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–ï¼šæª¢æŸ¥æ˜¯å¦æ”¯æ´ API
        document.addEventListener('DOMContentLoaded', () => {
            if (!('showDirectoryPicker' in window)) {
                showStatus('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æª”æ¡ˆç³»çµ±å­˜å– APIã€‚è«‹æ›´æ–°æˆ–ä½¿ç”¨ Chrome/Edge ç€è¦½å™¨ã€‚', 'error');
                document.getElementById('openDirBtn').disabled = true;
            }
        });

    </script>
</body>
</html>