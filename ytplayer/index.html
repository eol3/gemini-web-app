<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 播放器</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .sidebar {
            width: 100%;
            max-width: 900px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 900px;
        }

        .player-wrapper {
            width: 100%;
            max-width: 900px;
        }

        .bottom-container {
            width: 100%;
        }

        .input-wrapper {
            width: 100%;
        }

        .playlist-wrapper {
            width: 100%;
            max-width: 900px;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        .player-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .video-player {
            width: 100%;
            aspect-ratio: 16 / 9;
            height: auto;
            max-height: 60vh;
            background: #000;
        }

        .player-info {
            padding: 20px;
            background: #f8f9fa;
        }

        .player-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .input-section {
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .url-input-group {
            display: flex;
            gap: 10px;
        }

        .playlist-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .playlist-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
        }

        .playlist-items {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .playlist-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            background: white;
        }

        .playlist-item:hover {
            background: #fafafa;
        }

        .playlist-item.dragging {
            opacity: 0.5;
            background: #e9ecef;
        }

        .playlist-item.active {
            background: #f0f7ff;
        }

        .drag-handle {
            color: #adb5bd;
            cursor: grab;
            font-size: 20px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .item-thumbnail {
            width: 80px;
            height: 60px;
            background: #000;
            border-radius: 5px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-id {
            font-size: 12px;
            color: #666;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-play {
            background: #667eea;
            color: white;
        }

        .btn-play:hover {
            background: #5568d3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
        }

        .url-input-group input {
            flex: 1;
        }

        .url-input-group button {
            flex-shrink: 0;
        }

        .alert-box {
            margin-bottom: 15px;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .item-thumbnail {
                width: 60px;
                height: 45px;
            }

            .item-title {
                font-size: 12px;
            }

            .item-id {
                font-size: 10px;
            }
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <!-- 提示框 -->
        <div v-if="message.text" :class="['alert', 'alert-box', message.type === 'success' ? 'alert-success' : 'alert-danger']" role="alert">
            {{ message.text }}
        </div>

        <div class="container">
            <div class="main-container">
                <!-- 影片播放器區塊 -->
                <div class="player-wrapper">
                    <div class="player-container">
                        <div v-if="currentVideo" class="video-player" id="yt-player-container">
                            <div id="yt-player"></div>
                        </div>
                        <div v-else class="video-player" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0;">
                            <div style="text-align: center; color: #999;">
                                <i v-if="playlist.length === 0" class="fas fa-list" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                <i v-else class="fas fa-play" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                <p v-if="playlist.length === 0">播放清單為空</p>
                                <p v-else>請選擇播放清單中的影片</p>
                                <p style="font-size: 12px;" v-if="playlist.length === 0">請在下方新增 YouTube 影片開始</p>
                            </div>
                        </div>
                        <div class="player-info">
                            <div class="player-title">
                                {{ currentVideo ? currentVideo.title : '未選擇影片' }}
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                {{ currentVideo ? `影片 ID: ${currentVideo.id}` : '播放清單中沒有影片' }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 新增影片區塊 -->
                <div class="sidebar">
                    <div class="input-section">
                        <h4 class="mb-3">新增 YouTube 影片</h4>
                        <div class="url-input-group">
                            <input 
                                v-model="newUrl" 
                                type="text" 
                                class="form-control" 
                                placeholder="輸入 YouTube URL (如: https://www.youtube.com/watch?v=dQw4w9WgXcQ)"
                                @keyup.enter="addVideo"
                            >
                            <button class="btn btn-primary" @click="addVideo">
                                <i class="fas fa-plus"></i> 新增
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 播放列表區塊 -->
                <div class="playlist-wrapper">
                    <div class="playlist-section">
                        <div class="playlist-header">
                            <span>播放清單 ({{ playlist.length }})</span>
                            <div class="mode-selector">
                                <button 
                                    class="mode-btn" 
                                    :class="{ active: playMode === 'single' }"
                                    @click="playMode = 'single'"
                                    title="單曲循環"
                                >
                                    <i class="fas fa-redo"></i> 單曲
                                </button>
                                <button 
                                    class="mode-btn" 
                                    :class="{ active: playMode === 'loop' }"
                                    @click="playMode = 'loop'"
                                    title="重複循環"
                                >
                                    <i class="fas fa-sync"></i> 循環
                                </button>
                                <button 
                                    class="mode-btn" 
                                    :class="{ active: playMode === 'random' }"
                                    @click="playMode = 'random'"
                                    title="隨機播放"
                                >
                                    <i class="fas fa-random"></i> 隨機
                                </button>
                            </div>
                        </div>
                        <ul 
                            class="playlist-items"
                            @dragover="dragOverIndex = null"
                        >
                            <li v-if="playlist.length === 0" class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-list"></i>
                                </div>
                                <p>播放清單為空</p>
                                <p style="font-size: 12px;">請新增 YouTube 影片開始</p>
                            </li>
                            <li 
                                v-for="(item, index) in playlist" 
                                :key="item.id"
                                class="playlist-item"
                                :class="{ 
                                    'active': currentVideo && currentVideo.id === item.id,
                                    'dragging': draggedIndex === index
                                }"
                                draggable="true"
                                @dragstart="handleDragStart(index)"
                                @dragend="handleDragEnd"
                                @dragover.prevent="handleDragOver(index)"
                                @drop.prevent="handleDrop(index)"
                            >
                                <div class="drag-handle">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                <div class="item-thumbnail">
                                    <img :src="getThumbnailUrl(item.id)" :alt="item.title" style="width: 100%; height: 100%; object-fit: cover; border-radius: 5px;">
                                </div>
                                <div class="item-info">
                                    <div class="item-title">{{ item.title }}</div>
                                    <div class="item-id">{{ item.id }}</div>
                                </div>
                                <div class="item-actions">
                                    <button 
                                        class="btn-small btn-play" 
                                        @click="playVideo(index)"
                                    >
                                        <i class="fas fa-play"></i> 播放
                                    </button>
                                    <button 
                                        class="btn-small btn-delete" 
                                        @click="deleteVideo(index)"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const { createApp } = Vue;

        let youtubePlayer = null;

        const app = createApp({
            data() {
                return {
                    playlist: [],
                    currentIndex: -1,
                    newUrl: '',
                    playMode: 'loop', // 'single', 'loop', 'random'
                    draggedIndex: null,
                    dragOverIndex: null,
                    message: {
                        text: '',
                        type: 'success'
                    }
                };
            },
            computed: {
                currentVideo() {
                    return this.currentIndex >= 0 && this.currentIndex < this.playlist.length 
                        ? this.playlist[this.currentIndex] 
                        : null;
                }
            },
            watch: {
                currentVideo(newVal) {
                    if (newVal) {
                        // 如果播放器已初始化，加载并播放视频
                        if (youtubePlayer) {
                            youtubePlayer.loadVideoById(newVal.id);
                            youtubePlayer.playVideo();
                        } else {
                            // 如果播放器未初始化，初始化它
                            this.$nextTick(() => {
                                if (window.YT && window.YT.Player) {
                                    initYoutubePlayer();
                                }
                            });
                        }
                    }
                },
                playlist: {
                    handler(newVal) {
                        this.savePlaylist();
                    },
                    deep: true
                }
            },
            mounted() {
                window.youtubeApp = this;
                this.loadPlaylist();
            },
            methods: {
                extractVideoId(url) {
                    // 支持多种 YouTube URL 格式
                    const patterns = [
                        /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/,
                        /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([^?]+)/,
                        /^([a-zA-Z0-9_-]{11})$/ // 直接输入 video ID
                    ];

                    for (let pattern of patterns) {
                        const match = url.match(pattern);
                        if (match) {
                            return match[1];
                        }
                    }
                    return null;
                },
                getVideoTitle(videoId) {
                    // 从 video ID 生成标题（实际应用可通过 API 获取真实标题）
                    return `YouTube 影片 - ${videoId}`;
                },
                async fetchVideoTitle(videoId) {
                    try {
                        const response = await fetch(
                            `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`
                        );
                        if (response.ok) {
                            const data = await response.json();
                            return data.title;
                        }
                    } catch (error) {
                        console.error('取得影片標題失敗:', error);
                    }
                    return this.getVideoTitle(videoId);
                },
                getThumbnailUrl(videoId) {
                    // 返回 YouTube 视频缩图 URL
                    return `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                },
                addVideo() {
                    if (!this.newUrl.trim()) {
                        this.showMessage('請輸入 YouTube URL', 'danger');
                        return;
                    }

                    const videoId = this.extractVideoId(this.newUrl.trim());
                    
                    if (!videoId) {
                        this.showMessage('無效的 YouTube URL 格式', 'danger');
                        return;
                    }

                    // 检查是否已存在
                    if (this.playlist.some(v => v.id === videoId)) {
                        this.showMessage('該影片已在播放清單中', 'danger');
                        return;
                    }

                    // 使用默认标题创建视频对象，然后异步获取真实标题
                    const video = {
                        id: videoId,
                        title: this.getVideoTitle(videoId),
                        addedAt: new Date().toLocaleString('zh-TW')
                    };

                    this.playlist.push(video);
                    this.newUrl = '';
                    this.showMessage('影片已新增至播放清單', 'success');
                    
                    // 异步获取真实标题
                    this.fetchVideoTitle(videoId).then(title => {
                        // 找到該影片並更新標題
                        const videoItem = this.playlist.find(v => v.id === videoId);
                        if (videoItem) {
                            videoItem.title = title;
                        }
                    });
                    
                    // 如果是第一个视频，自动设置为当前播放视频
                    if (this.playlist.length === 1) {
                        this.currentIndex = 0;
                    }
                },
                playVideo(index) {
                    if (index >= 0 && index < this.playlist.length) {
                        this.currentIndex = index;
                    }
                },
                playNext() {
                    if (this.playlist.length === 0) return;

                    if (this.playMode === 'single') {
                        // 单曲循环：重新播放当前视频
                        if (youtubePlayer) {
                            youtubePlayer.playVideo();
                        }
                    } else if (this.playMode === 'loop') {
                        // 重复循环：播放下一个，到末尾时循环到开头
                        if (this.currentIndex < this.playlist.length - 1) {
                            this.currentIndex++;
                        } else {
                            this.currentIndex = 0;
                        }
                    } else if (this.playMode === 'random') {
                        // 随机播放：随机选择一个
                        this.currentIndex = Math.floor(Math.random() * this.playlist.length);
                    }
                },
                deleteVideo(index) {
                    if (index >= 0 && index < this.playlist.length) {
                        this.playlist.splice(index, 1);
                        
                        // 调整当前索引
                        if (this.currentIndex >= this.playlist.length) {
                            this.currentIndex = this.playlist.length - 1;
                        }
                        
                        this.showMessage('影片已刪除', 'success');
                    }
                },
                handleDragStart(index) {
                    this.draggedIndex = index;
                },
                handleDragEnd() {
                    this.draggedIndex = null;
                    this.dragOverIndex = null;
                },
                handleDragOver(index) {
                    if (this.draggedIndex !== null && this.draggedIndex !== index) {
                        this.dragOverIndex = index;
                    }
                },
                handleDrop(index) {
                    if (this.draggedIndex !== null && this.draggedIndex !== index) {
                        const draggedItem = this.playlist[this.draggedIndex];
                        const items = [...this.playlist];
                        items.splice(this.draggedIndex, 1);
                        items.splice(index, 0, draggedItem);
                        this.playlist = items;
                        
                        // 更新当前索引
                        if (this.currentIndex === this.draggedIndex) {
                            this.currentIndex = index;
                        } else if (this.draggedIndex < this.currentIndex && index >= this.currentIndex) {
                            this.currentIndex--;
                        } else if (this.draggedIndex > this.currentIndex && index <= this.currentIndex) {
                            this.currentIndex++;
                        }
                    }
                    this.draggedIndex = null;
                    this.dragOverIndex = null;
                },
                showMessage(text, type) {
                    this.message = { text, type };
                    setTimeout(() => {
                        this.message = { text: '', type: 'success' };
                    }, 3000);
                },
                savePlaylist() {
                    try {
                        const data = {
                            playlist: this.playlist,
                            playMode: this.playMode,
                            currentIndex: this.currentIndex,
                            savedAt: new Date().toISOString()
                        };
                        localStorage.setItem('youtubePlaylist', JSON.stringify(data));
                    } catch (error) {
                        console.error('保存播放清單失敗:', error);
                    }
                },
                loadPlaylist() {
                    try {
                        const saved = localStorage.getItem('youtubePlaylist');
                        if (saved) {
                            const data = JSON.parse(saved);
                            this.playlist = data.playlist || [];
                            this.playMode = data.playMode || 'loop';
                            // 不恢复 currentIndex，保持页面加载时影片区块为空白
                            this.currentIndex = -1;
                        }
                    } catch (error) {
                        console.error('載入播放清單失敗:', error);
                        this.playlist = [];
                        this.currentIndex = -1;
                    }
                }
            }
        }).mount('#app');

        // YouTube IFrame API 回调函数
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API 已加载');
            initYoutubePlayer();
        }

        function initYoutubePlayer() {
            const playerContainer = document.getElementById('yt-player');
            if (!playerContainer || youtubePlayer) return;

            console.log('初始化 YouTube 播放器');
            youtubePlayer = new YT.Player('yt-player', {
                height: '100%',
                width: '100%',
                videoId: '', // 不设置默认视频
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                },
                playerVars: {
                    controls: 1,
                    modestbranding: 1,
                    autoplay: 0,
                    fs: 1
                }
            });
            window.youtubePlayer = youtubePlayer;
        }

        function onPlayerReady(event) {
            console.log('播放器已准备就绪');
            // 如果有选中的视频，加载它
            if (window.youtubeApp && window.youtubeApp.currentVideo) {
                console.log('載入影片:', window.youtubeApp.currentVideo.id);
                youtubePlayer.loadVideoById(window.youtubeApp.currentVideo.id);
                // 延迟播放，确保视频已加载
                setTimeout(() => {
                    youtubePlayer.playVideo();
                }, 500);
            }
        }

        function onPlayerStateChange(event) {
            console.log('播放器状态变化:', event.data);
            // 0 = 已结束
            // 1 = 正在播放
            // 2 = 暂停
            // 3 = 缓冲
            // 5 = 已开始视频
            if (event.data === YT.PlayerState.ENDED) {
                if (window.youtubeApp) {
                    window.youtubeApp.playNext();
                }
            }
        }
    </script>
</body>
</html>
