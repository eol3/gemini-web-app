<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPFS Â§öÊ™îÊ°àË®ò‰∫ãÊú¨</title>
    <style>
        :root {
            --primary: #007AFF;
        }

        body {
            font-family: -apple-system, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f5f7;
        }

        header {
            background: #fff;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        #sidebar {
            width: 100%;
            max-height: 30vh;
            overflow-y: auto;
            background: white;
            border-bottom: 1px solid #ddd;
        }

        .file-item {
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .file-item.active {
            background: #e3f2fd;
            color: var(--primary);
            font-weight: bold;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        textarea {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            line-height: 1.5;
            outline: none;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-add {
            background: var(--primary);
            color: white;
        }

        .btn-del {
            background: #ff3b30;
            color: white;
            font-size: 12px;
        }

        .status {
            font-size: 12px;
            color: #888;
            text-align: center;
            padding: 5px;
        }
    </style>
</head>

<body>

    <header>
        <input type="text" id="newFileName" placeholder="Âª∫Á´ãÊñ∞Á¥îÊñáÂ≠óÊ™î..."
            style="flex:1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
        <button class="btn btn-add" onclick="createFile()">Êñ∞Â¢û</button>
        <label class="btn btn-add" style="background: #007AFF; margin-left:5px; cursor: pointer;">
            ‰∏äÂÇ≥Ê™îÊ°à
            <input type="file" id="fileInput" style="display:none" onchange="uploadFile(this)">
        </label>
    </header>

    <div id="sidebar"></div>

    <main id="editorArea" style="display:none;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div>
                <span id="currentTitle" style="font-weight: bold; font-size: 1.1em;"></span>
                <span id="fileTypeBadge"
                    style="font-size: 0.8em; background: #eee; padding: 2px 6px; border-radius: 4px; margin-left: 8px; color: #666;"></span>
            </div>
            <div>
                <button class="btn btn-add" style="background: #8e8e93; margin-right: 5px;"
                    onclick="downloadCurrentFile()">‰∏ãËºâ</button>
                <button class="btn btn-del" onclick="deleteFile()">Âà™Èô§</button>
            </div>
        </div>

        <!-- Text Editor -->
        <textarea id="editor" placeholder="Âú®Ê≠§Á∑®ËºØ..." style="display:none"></textarea>

        <!-- Media/Image Viewer -->
        <div id="mediaViewer"
            style="display:none; flex:1; flex-direction:column; justify-content:center; align-items:center; background:#f0f0f0; border-radius:8px; padding: 20px;">
            <img id="displayImage"
                style="max-width:100%; max-height:60vh; border-radius:4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display:none">

            <!-- General File Display -->
            <div id="binaryDisplay" style="text-align:center; display:none">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
                <div style="font-size: 16px; color: #555;">Ê≠§Ê™îÊ°àÁÑ°Ê≥ïÁõ¥Êé•È†êË¶Ω</div>
                <div style="font-size: 14px; color: #888; margin-top: 5px;">Ë´ã‰ΩøÁî®‰∏ãËºâÊåâÈàïÂÑ≤Â≠òÂà∞Êú¨Ê©ü</div>
            </div>
        </div>

        <button id="saveBtn" class="btn btn-add" style="margin-top:10px; background:#34c759"
            onclick="saveFile()">ÂÑ≤Â≠òËÆäÊõ¥</button>
    </main>

    <div id="status" class="status">Ê≠£Âú®ÂïüÂãïÁ≥ªÁµ±...</div>

    <script>
        const worker = new Worker('worker.js');

        let currentFileName = null;
        let currentFileType = 'text'; // text, image, binary
        let currentFileContent = null; // Buffer or String
        let currentMimeType = '';

        worker.onmessage = (e) => {
            const data = e.data;
            if (data.type === 'load') {
                openFileUI(data);
            } else if (data.type === 'done') {
                updateStatus(data.msg);
                refreshList();
            } else if (data.type === 'error') {
                updateStatus("ÈåØË™§: " + data.msg);
            }
        };

        function openFileUI(data) {
            document.getElementById('editorArea').style.display = 'flex';
            document.getElementById('currentTitle').innerText = data.fileName;
            document.getElementById('fileTypeBadge').innerText = data.fileType.toUpperCase();

            currentFileName = data.fileName;
            currentFileType = data.fileType;
            currentFileContent = data.content; // Keep for download
            currentMimeType = data.mimeType;

            const editor = document.getElementById('editor');
            const mediaViewer = document.getElementById('mediaViewer');
            const img = document.getElementById('displayImage');
            const binaryInfo = document.getElementById('binaryDisplay');
            const saveBtn = document.getElementById('saveBtn');

            // Reset views
            editor.style.display = 'none';
            mediaViewer.style.display = 'none';
            img.style.display = 'none';
            binaryInfo.style.display = 'none';
            saveBtn.style.display = 'none';

            if (data.fileType === 'text') {
                editor.style.display = 'block';
                editor.value = data.content;
                saveBtn.style.display = 'inline-block';
            } else if (data.fileType === 'image') {
                mediaViewer.style.display = 'flex';
                img.style.display = 'block';
                const blob = new Blob([data.content], { type: data.mimeType });
                img.src = URL.createObjectURL(blob);
            } else {
                // Binary / Other
                mediaViewer.style.display = 'flex';
                binaryInfo.style.display = 'block';
            }

            updateStatus(`Â∑≤ÈñãÂïü ${data.fileName}`);
            refreshList();
        }

        async function refreshList() {
            const sidebar = document.getElementById('sidebar');
            const root = await navigator.storage.getDirectory();
            const files = [];

            for await (const entry of root.values()) {
                if (entry.kind === 'file') {
                    files.push(entry.name);
                }
            }

            files.sort();
            sidebar.innerHTML = '';

            if (files.length === 0) {
                sidebar.innerHTML = '<div style="padding:20px;color:#888;text-align:center;">Â∞öÁÑ°Ê™îÊ°à</div>';
                return;
            }

            files.forEach(name => {
                const div = document.createElement('div');
                div.className = 'file-item' + (currentFileName === name ? ' active' : '');
                div.innerHTML = `<span>${name}</span>`;
                div.onclick = () => worker.postMessage({ type: 'read', fileName: name });
                sidebar.appendChild(div);
            });
        }

        function downloadCurrentFile() {
            if (!currentFileName || !currentFileContent) return;

            let blob;
            if (currentFileType === 'text') {
                // Get latest from editor if it's text
                const text = document.getElementById('editor').value;
                blob = new Blob([text], { type: 'text/plain' });
            } else {
                blob = new Blob([currentFileContent], { type: currentMimeType || 'application/octet-stream' });
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createFile() {
            let name = document.getElementById('newFileName').value.trim();
            if (!name) return;
            if (!name.includes('.')) name += '.txt'; // Default to txt if no ext
            worker.postMessage({ type: 'save', fileName: name, content: '' });
            document.getElementById('newFileName').value = '';
        }

        async function uploadFile(input) {
            const file = input.files[0];
            if (!file) return;

            const buffer = await file.arrayBuffer();
            worker.postMessage({
                type: 'save',
                fileName: file.name,
                content: buffer
            }, [buffer]);

            input.value = '';
        }

        function saveFile() {
            if (!currentFileName || currentFileType !== 'text') return;
            const content = document.getElementById('editor').value;
            worker.postMessage({ type: 'save', fileName: currentFileName, content });
        }

        function deleteFile() {
            if (!currentFileName || !confirm("Á¢∫ÂÆöÂà™Èô§ " + currentFileName + "Ôºü")) return;
            worker.postMessage({ type: 'delete', fileName: currentFileName });
            document.getElementById('editorArea').style.display = 'none';
            currentFileName = null;
        }

        function updateStatus(msg) {
            document.getElementById('status').innerText = msg;
        }

        // ÂïüÂãï
        refreshList();
        updateStatus("OPFS Ê™îÊ°àÁÆ°ÁêÜÂô®Â∞±Á∑í");
    </script>
</body>

</html>